!function(m,u,Q){"use strict";var A="ht",p=m[A],V=p.Default,P=V.def,s=V.getInternal();p.HistoryManager=function(v){this._histories=[],this.setDataModel(v)},P(p.HistoryManager,u,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var t=this;t._betweenTransaction++,1===t._betweenTransaction&&(t._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var V=this,e=V._histories;if(V._betweenTransaction>0&&V._betweenTransaction--,0===V._betweenTransaction){if(V._transactionHistories){var k=[];for(var w in V._transactionHistories)k.push(V._transactionHistories[w]);k.length&&(e=e.slice(0,V._historyIndex+1),e.push(k),e.length>V._maxHistoryCount&&(e=e.slice(e.length-V._maxHistoryCount)),V.setHistories(e),V.setHistoryIndex(e.length-1,!0))}delete V._transactionHistories}}},setDataModel:function(t){var w=this,u=w._dataModel;u!==t&&(u&&(delete u._historyManager,u.ump(w.handleDataModelPropertyChange,w),u.umm(w.$5p,w),u.umd(w.$6p,w),u.removeHierarchyChangeListener(w.handleHierarchyChange,w),u.removeIndexChangeListener(w.handleIndexChange,w)),w._dataModel=t,t&&(t._historyManager=w,t.mp(w.handleDataModelPropertyChange,w),t.mm(w.$5p,w),t.md(w.$6p,w),t.addHierarchyChangeListener(w.handleHierarchyChange,w),t.addIndexChangeListener(w.handleIndexChange,w)),w.fp("dataModel",u,t),w.clear())},setHistoryIndex:function(E,y){var V=this,g=V._historyIndex,A=V._histories.length;if(-1>E?E=-1:E>=A&&(E=A-1),g!==E){if(!y){var i=E-g;i>0?V.$2p(i):0>i&&V.$1p(-i)}V._historyIndex=E,V.fp("historyIndex",g,E),V.dataModel&&V.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(o){var Y=this,x=Y._histories,C=Y._maxHistoryCount;(!o||0>=o)&&(o=10),C!==o&&(Y._maxHistoryCount=o,Y.fp("maxHistoryCount",C,o),x.length>o&&Y.clear())},cloneValue:function(L){return p.Default.clone(L)},isPropertyUndoable:function(j){return j&&!this.ignoredPropertyMap[j]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(X){return X&&!this.ignoreDataModelPropertyMap[X]},$5p:function(R){this.handleChange(R,R.kind)},$6p:function(_){this.handleChange(_,"property")},handleHierarchyChange:function(r){this.handleChange(r,"hierarchy")},handleIndexChange:function(X){this.handleChange(X,"index")},handleDataModelPropertyChange:function(f){this.handleChange(f,"dataModelProperty")},toChildrenInfo:function(b){var g={};return g.data=b,g.children=[],b.eachChild(function(W){g.children.push(this.toChildrenInfo(W))},this),g},restoreChildren:function(S){var d=S.data;S.children.forEach(function(f){var Q=f.data;Q.getParent()!==d&&d.addChild(Q),this._dataModel.contains(Q)||this._dataModel.add(Q),this.restoreChildren(f)},this)},handleChange:function(x,E){var F=this;if(!(F._disabled||F._isUndoRedoing||V.loadingRefGraph)){var f,O=(F._histories,x.data),l=x.property;if(!O||!(O._refGraph||O instanceof p.RefGraph)){if("property"===E)F.isPropertyUndoable(l,O)&&(f={kind:E,data:O,property:l,oldValue:F.cloneValue(x.oldValue,O,l),newValue:F.cloneValue(x.newValue,O,l),event:x});else if("hierarchy"===E||"index"===E&&F.isIndexUndoable(x))f={kind:E,data:O,oldIndex:x.oldIndex,newIndex:x.newIndex,event:x};else if("clear"===E)f={kind:E,json:x.json,event:x};else if("add"===E){if(f={kind:E,data:O,event:x,childrenInfo:this.toChildrenInfo(O),parent:O.getParent()},f.parent){var s=F._dataModel.getSiblings(O);f.siblingsIndex=s.indexOf(O)}O instanceof p.Node&&(f.host=O.getHost(),f.attaches=O.getAttaches()?O.getAttaches().toArray():Q),O instanceof p.Edge&&(f.source=O.getSource(),f.target=O.getTarget())}else"remove"===E?f={kind:E,data:O,event:x}:"dataModelProperty"===E&&F.isDataModelPropertyUndoable(l,O)&&(f={kind:E,property:l,oldValue:F.cloneValue(x.oldValue,O,l),newValue:F.cloneValue(x.newValue,O,l),event:x});F.addHistory(f)}}},addHistory:function(K){var j=this;if(K)if(j._betweenTransaction){var Y=(K.data?K.data._id:0)+"_"+K.kind+"_"+K.property;if("property"===K.kind||"dataModelProperty"===K.kind){var A=j._transactionHistories[Y];A&&(K.oldValue=A.oldValue)}j._transactionHistories[Y]=K}else{var w=j._histories;w=w.slice(0,j._historyIndex+1),w.push([K]),w.length>j._maxHistoryCount&&(w=w.slice(w.length-j._maxHistoryCount)),j.setHistories(w),j.setHistoryIndex(w.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(w){(!w||0>=w)&&(w=1),this.setHistoryIndex(this._historyIndex-w)},$1p:function(L){if(this.canUndo()){var J,I=this,U=I._dataModel,m=I._histories,M=I._historyIndex,r=0;for(I._isUndoRedoing=!0,V.setIsolating(!0);L>0;){if(M>=0&&M<m.length){r++,J=m[M],M--;for(var h=J.length-1;h>=0;h--){var b=J[h],$=b.kind,v=b.data,e=b.property,y=b.event,g=this.cloneValue(b.oldValue,v,e);if(b.undo)b.undo();else if("add"===$)U.remove(v,{keepChildren:!0});else if("remove"===$)U.contains(v)||U.add(v,y.rootsIndex,y.datasIndex);else if("clear"===$)U.deserialize(V.clone(b.json));else if("property"===$)if("parent"===e)g?g.addChild(v,y.oldIndex):(v.setParent(g),y.oldIndex>=0&&U.moveTo(v,y.oldIndex));else{var a=null;0===e.indexOf("a:")?(a="attr",e=e.replace("a:","")):0===e.indexOf("s:")?(a="style",e=e.replace("s:","")):0===e.indexOf("f:")&&(a="field",e=e.replace("f:","")),s.setPropertyValue(v,a,e,g)}else if("dataModelProperty"===$){var a=null;0===e.indexOf("a:")?(a="attr",e=e.replace("a:","")):0===e.indexOf("s:")?(a="style",e=e.replace("s:","")):0===e.indexOf("f:")&&(a="field",e=e.replace("f:","")),s.setPropertyValue(U,a,e,g)}else"hierarchy"===$?U.moveTo(v,b.oldIndex):"index"===$&&U.moveToIndex(v,b.oldIndex)}}L--}V.setIsolating(!1),delete I._isUndoRedoing,I.afterUndo(r)}},afterUndo:function(){},redo:function(A){(!A||0>=A)&&(A=1),this.setHistoryIndex(this._historyIndex+A)},$2p:function(X){if(this.canRedo()){var m,Y=this,D=Y._dataModel,a=Y._histories,$=Y._historyIndex,g=0;for(Y._isUndoRedoing=!0,V.setIsolating(!0);X>0;){if($>=-1&&$<a.length-1){g++,$++,m=a[$];for(var w=0;w<m.length;w++){var H=m[w],b=H.kind,v=H.data,R=H.property,f=H.event,J=this.cloneValue(H.newValue,v,R);if(H.redo)H.redo();else if("add"===b)H.parent&&!v.getParent()&&H.parent.addChild(v,H.siblingsIndex),D.contains(v)||D.add(v,f.rootsIndex,f.datasIndex),this.restoreChildren(H.childrenInfo),v instanceof p.Node&&(v.setHost(H.host),H.attaches&&H.attaches.forEach(function(Y){Y.setHost(v)})),v instanceof p.Edge&&(v.setSource(H.source),v.setTarget(H.target));else if("remove"===b)D.remove(v);else if("clear"===b)D.clear();else if("property"===b)if("parent"===R)J?J.addChild(v,f.newIndex):(v.setParent(J),f.newIndex>=0&&D.moveTo(v,f.newIndex));else{var F=null;0===R.indexOf("a:")?(F="attr",R=R.replace("a:","")):0===R.indexOf("s:")?(F="style",R=R.replace("s:","")):0===R.indexOf("f:")&&(F="field",R=R.replace("f:","")),s.setPropertyValue(v,F,R,J)}else if("dataModelProperty"===b){var F=null;0===R.indexOf("a:")?(F="attr",R=R.replace("a:","")):0===R.indexOf("s:")?(F="style",R=R.replace("s:","")):0===R.indexOf("f:")&&(F="field",R=R.replace("f:","")),s.setPropertyValue(D,F,R,J)}else"hierarchy"===b?D.moveTo(v,H.newIndex):"index"===b&&D.moveToIndex(v,H.newIndex)}}X--}V.setIsolating(!1),delete Y._isUndoRedoing,this.afterRedo(g)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);